services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  clickhouse_init:
    image: curlimages/curl:latest
    container_name: clickhouse_init
    depends_on:
      clickhouse:
        condition: service_healthy
    configs:
      - source: clickhouse_init_sql
        target: /init.sql
    command:
      - sh
      - -c
      - |
        echo "Creating table in ClickHouse..."
        curl -s http://clickhouse:8123/ --data-binary @/init.sql
        echo "Table creation completed."

  pushgateway_init:
    image: curlimages/curl:latest
    container_name: pushgateway_init
    depends_on:
      pushgateway:
        condition: service_healthy
    command:
      - sh
      - -c
      - |
        echo "Initializing ETL progress in PushGateway..."
        TIMESTAMP_PROGRESS=$(date +%s)
        curl -s -X POST http://pushgateway:9091/metrics/job/etl_prometheus2clickhouse/instance/etl_prometheus2clickhouse \
          -d "# TYPE etl_timestamp_progress gauge
        etl_timestamp_progress $TIMESTAMP_PROGRESS
        "
        echo "ETL progress initialized with timestamp: $TIMESTAMP_PROGRESS"

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    volumes:
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      - pushgateway

  pushgateway:
    image: prom/pushgateway:latest
    container_name: pushgateway
    ports:
      - "9091:9091"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9091/-/healthy"]
      interval: 5s
      timeout: 3s
      retries: 5

  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9100/metrics"]
      interval: 5s
      timeout: 3s
      retries: 5

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    configs:
      - source: grafana_datasources
        target: /etc/grafana/provisioning/datasources/datasources.yml
    volumes:
      - grafana_data:/var/lib/grafana
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      prometheus:
        condition: service_healthy
      clickhouse:
        condition: service_healthy

configs:
  prometheus_config:
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
        external_labels:
          monitor: 'etl-prometheus2clickhouse'

      scrape_configs:
        - job_name: 'pushgateway'
          static_configs:
            - targets: ['pushgateway:9091']
          honor_labels: true

        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']

        - job_name: 'node_exporter'
          static_configs:
            - targets: ['node_exporter:9100']

  grafana_datasources:
    content: |
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus:9090
          isDefault: true
          editable: false
        - name: ClickHouse
          type: grafana-clickhouse-datasource
          access: proxy
          jsonData:
            defaultDatabase: default
            port: 8123
            host: clickhouse
            username: default
            protocol: http
          secureJsonData: {}
          editable: false

  clickhouse_init_sql:
    content: |
      CREATE TABLE IF NOT EXISTS default.prometheus_raw (
          timestamp DateTime,
          metric_name String,
          labels String,
          value Float64
      ) ENGINE = ReplacingMergeTree()
      ORDER BY (timestamp, metric_name, labels);

volumes:
  clickhouse_data:
  clickhouse_logs:
  prometheus_data:
  grafana_data:
