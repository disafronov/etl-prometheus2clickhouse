x-clickhouse-image: &clickhouse-image altinity/clickhouse-server:25.3.8.10041.altinitystable

services:
  clickhouse:
    image: *clickhouse-image
    container_name: clickhouse
    ports:
      - "8123:8123"
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  clickhouse_init:
    image: *clickhouse-image
    container_name: clickhouse_init
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - INIT_TIMESTAMP_PROGRESS=${INIT_TIMESTAMP_PROGRESS:-}
    configs:
      - source: clickhouse_init_sql_metrics
        target: /init_metrics.sql
      - source: clickhouse_init_sql_etl
        target: /init_etl.sql
    command:
      - sh
      - -c
      - |
        echo "Creating tables in ClickHouse..."
        clickhouse-client --host=clickhouse --query="$(cat /init_metrics.sql)"
        clickhouse-client --host=clickhouse --query="$(cat /init_etl.sql)"
        echo "Table creation completed."
        TIMESTAMP_PROGRESS=$${INIT_TIMESTAMP_PROGRESS:-$(date +%s)}
        echo "Setting initial timestamp_progress to: $$TIMESTAMP_PROGRESS"
        clickhouse-client --host=clickhouse --query="INSERT INTO default.etl (timestamp_start, timestamp_end, timestamp_progress) VALUES ($$TIMESTAMP_PROGRESS, $$((TIMESTAMP_PROGRESS + 1)), $$TIMESTAMP_PROGRESS)"
        echo "Initial timestamp_progress set."

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    volumes:
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 5s
      timeout: 3s
      retries: 5


  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9100/metrics"]
      interval: 5s
      timeout: 3s
      retries: 5

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    configs:
      - source: grafana_datasources
        target: /etc/grafana/provisioning/datasources/datasources.yml
    volumes:
      - grafana_data:/var/lib/grafana
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      prometheus:
        condition: service_healthy
      clickhouse:
        condition: service_healthy

configs:
  prometheus_config:
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
        external_labels:
          monitor: 'etl-prometheus2clickhouse'

      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']

        - job_name: 'node_exporter'
          static_configs:
            - targets: ['node_exporter:9100']

  grafana_datasources:
    content: |
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus:9090
          isDefault: true
          editable: false
        - name: ClickHouse
          type: grafana-clickhouse-datasource
          access: proxy
          jsonData:
            defaultDatabase: default
            port: 8123
            host: clickhouse
            username: default
            protocol: http
          secureJsonData: {}
          editable: false

  clickhouse_init_sql_metrics:
    content: |
      CREATE TABLE IF NOT EXISTS default.metrics (
          timestamp DateTime,
          metric_name String CODEC(ZSTD(3)),
          labels String CODEC(ZSTD(3)),
          value Float64
      ) ENGINE = ReplacingMergeTree()
      PARTITION BY toYYYYMMDD(timestamp)
      ORDER BY (timestamp, metric_name, labels);

  clickhouse_init_sql_etl:
    content: |
      CREATE TABLE IF NOT EXISTS default.etl (
          timestamp_start Nullable(Int64) CODEC(ZSTD(3)),
          timestamp_end Nullable(Int64) CODEC(ZSTD(3)),
          timestamp_progress Nullable(Int64) CODEC(ZSTD(3)),
          batch_window_seconds Nullable(Int64) CODEC(ZSTD(3)),
          batch_rows Nullable(Int64) CODEC(ZSTD(3))
      ) ENGINE = ReplacingMergeTree()
      ORDER BY (timestamp_start)
      SETTINGS allow_nullable_key = 1;

volumes:
  clickhouse_data:
  clickhouse_logs:
  prometheus_data:
  grafana_data:
