---
name: Lint and test

"on":
  pull_request:
    branches:
      - main
      - release

jobs:
  lint_and_test:
    name: "Lint and test"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Read Python version
        id: python_version
        run: echo "version=$(cat .python-version | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-suffix: ${{ steps.python_version.outputs.version }}

      - name: Install dependencies
        run: uv sync --python ${{ steps.python_version.outputs.version }}
        env:
          UV_PYTHON: ${{ steps.python_version.outputs.version }}

      - name: Run all checks
        run: make all
        env:
          UV_PYTHON: ${{ steps.python_version.outputs.version }}

      - name: Check if code was reformatted
        if: always()
        run: git diff --exit-code
